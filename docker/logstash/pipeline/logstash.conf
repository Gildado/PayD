# PayD Logstash Pipeline Configuration
#
# Receives JSON logs from the PayD backend via TCP,
# processes and enriches them, then ships to Elasticsearch.

input {
  # TCP input for JSON structured logs
  tcp {
    port => 5000
    codec => json_lines
    type => "payd-backend"
  }

  # Beats input (for Filebeat if used)
  beats {
    port => 5044
    type => "payd-filebeat"
  }
}

filter {
  # Parse timestamp if present
  if [timestamp] {
    date {
      match => ["timestamp", "ISO8601", "yyyy-MM-dd HH:mm:ss.SSS"]
      target => "@timestamp"
    }
  }

  # Add environment metadata
  mutate {
    add_field => {
      "[@metadata][index_prefix]" => "payd"
    }
  }

  # Route based on log type
  if [type] == "performance" {
    mutate {
      add_field => { "[@metadata][index_suffix]" => "performance" }
    }
  } else if [type] == "security" {
    mutate {
      add_field => { "[@metadata][index_suffix]" => "security" }
    }
  } else if [type] == "transaction" {
    mutate {
      add_field => { "[@metadata][index_suffix]" => "transactions" }
    }
  } else if [type] == "error" or [level] == "error" {
    mutate {
      add_field => { "[@metadata][index_suffix]" => "errors" }
    }
  } else if [type] == "http" {
    mutate {
      add_field => { "[@metadata][index_suffix]" => "access" }
    }
  } else if [type] == "tracing" {
    mutate {
      add_field => { "[@metadata][index_suffix]" => "traces" }
    }
  } else {
    mutate {
      add_field => { "[@metadata][index_suffix]" => "logs" }
    }
  }

  # Extract and enrich trace context
  if [traceId] {
    mutate {
      add_field => { "trace.id" => "%{traceId}" }
    }
  }
  if [spanId] {
    mutate {
      add_field => { "trace.span_id" => "%{spanId}" }
    }
  }

  # Parse HTTP status codes into categories
  if [statusCode] {
    if [statusCode] >= 500 {
      mutate { add_field => { "http.status_category" => "server_error" } }
    } else if [statusCode] >= 400 {
      mutate { add_field => { "http.status_category" => "client_error" } }
    } else if [statusCode] >= 300 {
      mutate { add_field => { "http.status_category" => "redirect" } }
    } else if [statusCode] >= 200 {
      mutate { add_field => { "http.status_category" => "success" } }
    }
  }

  # Remove unnecessary fields
  mutate {
    remove_field => ["@version", "host", "port"]
  }
}

output {
  # Ship to Elasticsearch with date-based indices
  elasticsearch {
    hosts => ["http://elasticsearch:9200"]
    index => "%{[@metadata][index_prefix]}-%{[@metadata][index_suffix]}-%{+YYYY.MM.dd}"
    action => "index"
  }

  # Debug output (disable in production)
  if [@metadata][index_suffix] == "errors" {
    stdout {
      codec => rubydebug
    }
  }
}
